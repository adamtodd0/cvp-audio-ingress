trigger: none
schedules:
- cron: '0 1 * * *'
  displayName: 'daily run'
  branches:
    include: [ 'refs/heads/master' ]
  always: true

parameters:
  - name: env
    displayName: Environment to Deploy to
    type: string
    default: sbox
    values:
      - sbox
      - stg
      - prod

variables:
  - template: pipeline/variables-common.yaml
  - ${{ if ne(parameters.env, 'prod') }}:
    - template: pipeline/variables-${{parameters.env}}.yaml
    - group: cvp-${{parameters.env}}
  - ${{ if and(contains(variables['Build.SourceBranch'], 'refs/heads/master'), eq(parameters.env, 'prod')) }}:
    # Production (prod)
    - template: pipeline/variables-prod.yaml
    - group: cvp-prod

stages:
  - stage: Build
    jobs:
      - job: BasicValidation
        steps:
          - template: pipeline/steps/tf-install.yaml
          - template: pipeline/steps/tf-init.yaml
            parameters:
              useBackend: false
          - task: TerraformCLI@0
            displayName: Validate Terraform
            inputs:
              command: 'validate'
              commandOptions: '-no-color'
          - script: terraform fmt -check=true
            displayName: Check Formatting

  - stage: Plan
    dependsOn: Build
    jobs:
      - job: PlanToEnv
        displayName: 'Plan to ${{parameters.env}}'
        steps:

          - template: pipeline/steps/tf-init.yaml
            parameters:
              useBackend: true

          - template: pipeline/steps/tf-plan.yaml
            parameters:
              subscriptionName: $(subscriptionName)
              env: $(env)
              certName: $(certName)
              location: $(location)
              product: $(product)
              builtFrom: $(Build.Repository.Name)
              # Manually passed in for use in scripts where resources are tagged
              businessArea: $(businessArea)
              application: $(application)
  
  - stage: Validate
    dependsOn: Plan
    jobs:
      - job: ValidateChanges
        displayName: 'Validate outstanding Terraform changes'
        steps: 
          - download: current
            artifact: '${{ parameters.env }}.tfplan'
            displayName: 'Download ${{ parameters.env }} Plan file'

          - template: pipeline/steps/tf-show.yml
            parameters: 
              planOrStateFilePath: "$(Pipeline.Workspace)/${{ parameters.env }}.tfplan/${{ parameters.env }}.tfplan"
              outputLocation: "$(Pipeline.Workspace)/${{ parameters.env }}.json"

          - powershell: |
              $environment = "${{parameters.env}}"
              $planObj = Get-Content "$(Pipeline.Workspace)/${{ parameters.env }}.json" | ConvertFrom-Json
              $resourceChanges = $planObj.resource_changes

              $addChanges = ($resourceChanges | Where {$_.change.actions -contains "create"}).length
              $changeChanges = ($resourceChanges | Where {$_.change.actions -contains "update"}).length
              $removeChanges = ($resourceChanges | Where {$_.change.actions -contains "delete"}).length

              $msg = "There are " + $resourceChanges.length + " ($addChanges to add, $changeChanges to change, $removeChanges to remove) in the $environment Environment on CVP Audio Ingress"
              Write-Host $msg

              $sendMsg = (&{If($addChanges -gt 0 -or $changeChanges -gt 0 -or $removeChanges -gt 0) {"true"} Else {"false"}})

              $icon = (&{If($environment -eq 'prod' ) {":bangbang:"} Else {":heavy_exclamation_mark:"}})

              Write-Host "##vso[task.setvariable variable=sendMsg;isOutput=true]$sendMsg"
              Write-Host "##vso[task.setvariable variable=msg;isOutput=true]$msg"
              Write-Host "##vso[task.setvariable variable=icon;isOutput=true]$icon"
            name: 'terraChanges'
            displayName: 'Validate any changes'
          
          - ${{ if eq(variables['sendMsg'], 'true') }}:
            - template: pipeline/steps/send-im.yml
              parameters:
                hookUrl: ${{variables.slackWebHook}}
                title: "Terraform Changes in ${{parameters.env}}"
                message: "$(terraChanges.msg)"
                emojiIcon: "$(terraChanges.icon)"