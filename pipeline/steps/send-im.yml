parameters:
  - name: hookUrl
    type: string
  - name: title
    type: string
  - name: message
    type: string
  - name: emojiIcon
    type: string
    default: ':speech_balloon:'
    values:
      - ':heavy_exclamation_mark:'
      - ':bangbang:'
      - ':white_check_mark:'
      - ':sos:'
      - ':speech_balloon:'
  - name: conditionAction
    type: string
    default: 'true'

steps:
  - powershell: | 
      $conditionAction = "${{ parameters.conditionAction }}"
      Write-Host "Should send slack $conditionAction"
      if ($conditionAction -eq 'true') {
        Write-Host "Sending slack message"

        $url = "${{parameters.hookUrl}}"
        $title = "${{parameters.title}}"
        $message = "${{parameters.message}}"
        $emojiIcon = "${{parameters.emojiIcon}}"

        try {

            $body = 
            {
                pretext= "$title",
                text= "$message",
                icon_emoji="$emojiIcon"
            }

            Invoke-WebRequest -Method Post -Uri $url -Body ($body | ConvertTo-Json) -ContentType 'application/json'
            Write-Host "Message has been sent"
        }
        catch
        {
            Write-Host "failed: $_"
            Write-Host  "##vso[task.LogIssue type=error;]$_."
        }
      }
    displayName: 'Send Slack Message'